// ==UserScript==
// @name        Every Page Worker ğŸ’¢ğŸ’¢ h-update
// @namespace        http://tampermonkey.net/
// @version        5.1
// @description        ã€Œè¨˜äº‹ã®ç·¨é›†ãƒ»å‰Šé™¤ã€ã§ãƒ–ãƒ­ã‚°å…¨è¨˜äº‹ã‚’é–‹ã„ã¦æ›´æ–°ã‚’å®Ÿè¡Œ
// @author        Ameba Blog User
// @match        https://blog.ameba.jp/ucs/entry/srventrylist*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdate*
// @icon        https://www.google.com/s2/favicons?sz=64&domain=ameba.jp
// @run-at        document-start
// @grant        none
// @updateURL        https://github.com/personwritep/Every_Page_Worker_h-update/raw/main/Every_Page_Worker_h-update.user.js
// @downloadURL        https://github.com/personwritep/Every_Page_Worker_h-update/raw/main/Every_Page_Worker_h-update.user.js
// ==/UserScript==


window.addEventListener('DOMContentLoaded', function(){ // CSSãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é©ç”¨ã™ã‚‹
    let body_id=document.body.getAttribute('id');
    if(body_id=='entryListEdit'){ //ã€Œè¨˜äº‹ã®ç·¨é›†ãƒ»å‰Šé™¤ã€ã®ç”»é¢ã«ã®ã¿CSSé©ç”¨

        let style=
            '<style>'+
            '#globalHeader, #ucsHeader, #ucsMainLeft h1, .l-ucs-sidemenu-area, .selection-bar { '+
            'display: none !important; } '+

            '#ucsContent { width: 930px !important; } '+
            '#ucsContent::before { display: none; } '+
            '#ucsMainLeft { width: 930px !important; padding: 0 15px !important; } '+

            '#entrySort { margin-bottom: 2px; } '+
            '#nowMonth { color: #000; } '+
            '#entryListEdit form { display: flex; flex-direction: column; } '+
            '#entrySort { order: -2; } '+
            '.pagingArea { order: -1; margin-bottom: -33px; position:unset !important; } '+
            '.pagingArea a { border: 1px solid #888; } '+
            '.pagingArea .active{ border: 2px solid #0066cc; } '+
            '.pagingArea a, .pagingArea .active, .pagingArea .disabled { font-size: 14px; line-height: 23px; } '+
            '#sorting { margin: 36px 0 4px; padding: 2px 0; height: 78px; background: #ddedf3; } '+
            '#sorting select, #sorting ul { display: none; } '+

            '#entryList .status-text { right: 374px !important; } '+
            '#entryList .entry-info .date { right: 260px !important; } '+
            '#entryList .actions { width: 240px; } '+

            '#div0 { color: #333; font-size: 14px; margin: 0 -10px 0 15px; } '+
            '#div1 { color: #000; font-size: 14px; margin: 1px 15px; background: #c0dbed; } '+
            '#list_snap { padding: 2px 0 0; margin: 7px 20px 7px 0; width: 180px; } '+
            '#reset { padding: 2px 0 0; margin-right: 20px; width: 60px; } '+
            '#export { padding: 2px 0 0; margin: 7px 10px 7px 0; width: 100px; } '+
            '.snap_result { display: inline-block; margin: 6px 4px 4px 12px; } '+
            '.num { padding: 2px 2px 0 6px; width: 40px; } '+
            '.editor_open { padding: 2px 0 0; margin: 0 20px 0 4px; width: 50px; } '+
            'input { font-family: meiryo; font-size: 14px; } '+
            '.ch1, .ch2 { font: 15px/27px Meiryo; color: #0277bd; opacity: 0; }'+
            '.ch1 { margin-left: 8px; } '+
            '.ch2 { margin-left: 2px; } '+
            '</style>';

        document.head.insertAdjacentHTML('beforeend', style);

        let actions=document.querySelectorAll('#entryList .actions');
        for(let k=0; k<actions.length; k++){
            let iAH='<span class="ch1">â¶</span><span class="ch2">â·</span>';
            actions[k].insertAdjacentHTML('beforeend', iAH); }

    }})



window.addEventListener('load', function(){ // è¦ªã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã§åƒããƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    let body_id=document.body.getAttribute('id');
    if(body_id=='entryListEdit'){ // è¦ªã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã®æ¡ä»¶

        let drive_mode; // ãƒšãƒ¼ã‚¸æ›´æ–°æ™‚ã®å‹•ä½œãƒ¢ãƒ¼ãƒ‰
        let blogDB={}; //ã€Œå¯¾è±¡è¨˜äº‹ã®ID/ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ©ã‚° ã¾ãŸã¯å†…å®¹ã€ã®è¨˜éŒ²é…åˆ—

        let entry_id_DB; // IDæ¤œç´¢ç”¨ã®é…åˆ—
        let pub_1; // flag 1 ãŒè¨˜éŒ²ã•ã‚ŒãŸè¨˜äº‹ç·æ•°
        let pub_2; // flag 2 ãŒè¨˜éŒ²ã•ã‚ŒãŸè¨˜äº‹ç·æ•°

        let entry_id;
        let entry_target;
        let list_bar;
        let editor_flg;

        let next_target; // ãƒšãƒ¼ã‚¸å†…ã®æ¬¡ã®å¯¾è±¡è¨˜äº‹
        let new_win;
        let link_target;
        let editor_iframe;
        let iframe_doc;

        let ua=0;
        let agent=window.navigator.userAgent.toLowerCase();
        if(agent.indexOf('firefox') > -1){ ua=1; } // Firefoxã®å ´åˆã®ãƒ•ãƒ©ã‚°


        let read_json=localStorage.getItem('EPW_DB_back'); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜å
        blogDB=JSON.parse(read_json);
        if(blogDB==null){
            blogDB=[['epw00000000', 's', 0]]; }
        drive_mode=blogDB[0][1]; // èµ·å‹•æ™‚ã«å‹•ä½œãƒ•ãƒ©ã‚°ã‚’å–å¾—
        blogDB[0][1]='s'; // ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ç­‰ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
        let write_json=JSON.stringify(blogDB);
        localStorage.setItem('EPW_DB_back', write_json); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜

        reg_set();

        function reg_set(){
            let k;
            entry_id_DB=[]; // ãƒªã‚»ãƒƒãƒˆ
            pub_1=0;
            pub_2=0;

            for(k=0; k<blogDB.length; k++){
                entry_id_DB[k]=blogDB[k][0]; // IDæ¤œç´¢ç”¨ã®é…åˆ—ã‚’ä½œæˆ
                if(blogDB[k][1]=='1'){
                    pub_1 +=1; } // flag 1 ãŒè¨˜éŒ²ã•ã‚ŒãŸè¨˜äº‹ç·æ•°ï¼ˆæ¤œç´¢1ï¼‰
                if(blogDB[k][2]=='1'){
                    pub_2 +=1; }}} // flag 2 ãŒè¨˜éŒ²ã•ã‚ŒãŸè¨˜äº‹ç·æ•°ï¼ˆæ¤œç´¢2ï¼‰


        entry_id=document.querySelectorAll('input[name="entry_id"]');
        entry_target=document.querySelectorAll('.entry-item .entry');
        list_bar=document.querySelectorAll('#entryList .entry-item');


        control_pannel(drive_mode);

        hit_display();

        function control_pannel(dm){
            let sty;
            let insert_div0;
            insert_div0=document.createElement('div');
            insert_div0.setAttribute('id', 'div0');
            let box=document.querySelector('#sorting');
            box.appendChild(insert_div0);

            let insert_div1;
            insert_div1=document.createElement('div');
            insert_div1.setAttribute('id', 'div1');
            box.appendChild(insert_div1);

            let button1=document.createElement('input');
            button1.setAttribute('id', 'list_snap');
            button1.setAttribute('type', 'submit');
            insert_div0.appendChild(button1);
            if(dm=='s'){
                button1.setAttribute('value', 'å…¨è¨˜äº‹ã¸å‡¦ç†ã‚’é–‹å§‹ã€€â–¶'); }
            else if(dm=='c'){
                button1.setAttribute('value', 'ã€€å‡¦ç†ã‚’ä¸€æ—¦åœæ­¢ã€€ã€€âšâš'); }
            else if(dm=='e'){
                button1.setAttribute('value', 'å‡¦ç†ãŒå…¨ã¦çµ‚äº†ã—ã¾ã—ãŸ'); }

            button1.addEventListener('click', function(e){
                e.preventDefault();
                if(e.ctrlKey){
                    start_stop(1); } // ãƒšãƒ¼ã‚¸ã®é€”ä¸­ã‹ã‚‰é€£ç¶šå‡¦ç†ã‚¹ã‚¿ãƒ¼ãƒˆ
                else{
                    start_stop(0); }}, false);


            function start_stop(n){
                if(drive_mode=='s'){ // æœ€åˆã®èµ·å‹•ç›´å¾Œ
                    let conf_str='ã€€ã€€ ğŸ”´ã€€ã“ã®ãƒšãƒ¼ã‚¸ä»¥é™ã®è¨˜äº‹ã«é€£ç¶šã—ãŸå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™'+
                        '\n\nã€€ã€€ã€€ã€€  åœæ­¢ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã§å‡¦ç†åœæ­¢/å‡¦ç†å†é–‹ãŒã§ãã¾ã™';
                    let ok=confirm(conf_str);
                    if(ok){
                        drive_mode='c'; // ãƒšãƒ¼ã‚¸å†…ã®é€£ç¶šå‡¦ç†
                        button1.setAttribute('value', 'ã€€å‡¦ç†ã‚’ä¸€æ—¦åœæ­¢ã€€ã€€âšâš');
                        if(n==0){
                            next(0); }
                        else{
                            alert('ã€€å‡¦ç†ã‚’é–‹å§‹ã™ã‚‹è¨˜äº‹ã‚’å·¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
                            clicked_item(); }}}

                else if(drive_mode=='c'){ // é€£ç¶šå‹•ä½œçŠ¶æ…‹ã®å ´åˆ
                    drive_mode='p'; // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ã€Œpã€åœæ­¢ãƒ¢ãƒ¼ãƒ‰
                    button1.setAttribute('value', 'ã€€å‡¦ç†ã‚’å†é–‹ã™ã‚‹ã€€ã€€â–¶'); }

                else if(drive_mode=='p'){ // å‹•ä½œåœæ­¢çŠ¶æ…‹ã®å ´åˆ
                    drive_mode='c'; // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰é€£ç¶šå‹•ä½œã‚’å†é–‹
                    button1.setAttribute('value', 'ã€€å‡¦ç†ã‚’ä¸€æ—¦åœæ­¢ã€€ã€€âšâš');
                    open_win(next_target); }

                function clicked_item(){
                    let entry_item=document.querySelectorAll('.entry-item');
                    for(let k=0; k<entry_item.length; k++){
                        entry_item[k].onclick=function(e){
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            next(k); }}}
            } // start_stop()


            if(dm=='c'){ // ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã«ã€Œcã€ã¯é€£ç¶šå‹•ä½œ
                setTimeout(next(0), 200); } // ã€Œcã€é€£ç¶šå‹•ä½œã¯ãºãƒ¼ã‚¸é·ç§»æ™‚ 0.2sec ã§è‡ªå‹•å®Ÿè¡Œ â­•
            else if(dm=='e'){ // ã€Œeã€ã¯çµ‚äº†
                button1.style.pointerEvents='none'; }


            let button2=document.createElement('input');
            button2.setAttribute('id', 'reset');
            button2.setAttribute('type', 'submit');
            button2.setAttribute('value', 'åˆæœŸåŒ–');
            insert_div0.appendChild(button2);

            button2.onclick=function(e){
                e.preventDefault();
                blogDB=[['epw00000000', 's', 0]];
                let write_json=JSON.stringify(blogDB);
                localStorage.setItem('EPW_DB_back', write_json); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜
                snap_disp();
                hit_display_clear();
                document.querySelector('#reset').value='ã€”ã€€ã€•'; }

            let button3=document.createElement('input');
            button3.setAttribute('id', 'export');
            button3.setAttribute('type', 'submit');
            button3.setAttribute('value', 'ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜');
            insert_div0.appendChild(button3);

            button3.onclick=function(e){
                e.preventDefault();
                let write_json=JSON.stringify(blogDB);
                let blob=new Blob([write_json], {type: 'application/json'});
                let a_elem=document.createElement('a');
                a_elem.href=URL.createObjectURL(blob);
                a_elem.download='EPW.json'; // ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å
                if(ua==1){
                    a_elem.target='_blank';
                    document.body.appendChild(a_elem); }
                a_elem.click();
                if(ua==1){
                    document.body.removeChild(a_elem); }
                URL.revokeObjectURL(a_elem.href); }

            let button4=document.createElement('input');
            button4.setAttribute('type', 'file');
            button4.setAttribute('style', 'vertical-align: 1px; width: 390px');
            insert_div0.appendChild(button4);

            button4.addEventListener("change", function(){
                if(!(button4.value)) return; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œãªã„å ´åˆ
                let file_list=button4.files;
                if(!file_list) return; // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒé¸æŠã•ã‚Œãªã„å ´åˆ
                let file=file_list[0];
                if(!file) return; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡ã„å ´åˆ

                let file_reader=new FileReader();
                file_reader.readAsText(file);
                file_reader.onload=function(){
                    if(file_reader.result.slice(0, 15)=='[["epw00000000"'){ // EPW.jsonã®ç¢ºèª
                        let data_in=JSON.parse(file_reader.result);
                        blogDB=data_in; // èª­è¾¼ã¿ä¸Šæ›¸ãå‡¦ç†
                        let write_json=JSON.stringify(blogDB);
                        localStorage.setItem('EPW_DB_back', write_json); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜
                        button2.setAttribute('value', 'åˆæœŸåŒ–'); // åˆæœŸåŒ–å¾Œãªã‚‰èª­ã¿è¾¼ã‚“ã äº‹ã‚’ç¤ºã™
                        snap_disp(); }
                    else{
                        alert("   â›” ä¸é©åˆãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™  EPW.json ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");}};});

            let span5=document.createElement('span');
            span5.setAttribute('id', 'snap_result1');
            span5.setAttribute('class', 'snap_result');
            insert_div1.appendChild(span5);

            let button6=document.createElement('input');
            button6.setAttribute('id', 'num_1');
            button6.setAttribute('class', 'num');
            button6.setAttribute('type', 'number');
            button6.setAttribute('min', '0');
            insert_div1.appendChild(button6);

            let button7=document.createElement('input');
            button7.setAttribute('class', 'editor_open');
            button7.setAttribute('type', 'submit');
            button7.setAttribute('value', 'ç·¨é›†');
            insert_div1.appendChild(button7);

            button7.onclick=function(e){
                e.preventDefault();
                let k;
                let pub_1_DB=[]; // pub_1 ã® entry_id ã®é…åˆ—
                if(pub_1>0){
                    for(k=0; k<blogDB.length; k++){
                        if(blogDB[k][1]=='1'){
                            pub_1_DB.push(blogDB[k][0]); }}

                    if(button6.value>0){
                        let open_id=pub_1_DB[button6.value -1];
                        let pass=
                            'https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id='+ open_id;
                        let win_option='top=20, left=40, width=1020, height=900';
                        window.open(pass, button6.value, win_option); }}}

            let span8=document.createElement('span');
            span8.setAttribute('id', 'snap_result2');
            span8.setAttribute('class', 'snap_result');
            insert_div1.appendChild(span8);

            let button9=document.createElement('input');
            button9.setAttribute('id', 'num_2');
            button9.setAttribute('class', 'num');
            button9.setAttribute('type', 'number');
            button9.setAttribute('min', '0');
            insert_div1.appendChild(button9);

            let button10=document.createElement('input');
            button10.setAttribute('class', 'editor_open');
            button10.setAttribute('type', 'submit');
            button10.setAttribute('value', 'ç·¨é›†');
            insert_div1.appendChild(button10);

            button10.onclick=function(e){
                e.preventDefault();
                let k;
                let pub_2_DB=[]; // pub_2 ã® entry_id ã®é…åˆ—
                if(pub_2>0){
                    for(k=0; k<blogDB.length; k++){
                        if(blogDB[k][2]=='1'){
                            pub_2_DB.push(blogDB[k][0]); }}

                    if(button9.value>0){
                        let open_id=pub_2_DB[button9.value -1];
                        let pass=
                            'https://blog.ameba.jp/ucs/entry/srventryupdateinput.do?id='+ open_id;
                        let win_option='top=20, left=40, width=1020, height=900';
                        window.open(pass, button9.value, win_option); }}}

            snap_disp();

        } // control_pannel()


        function snap_disp(){
            reg_set();
            let span5=document.querySelector('#snap_result1');
            span5.textContent='è¨˜éŒ²ä»¶æ•°ï¼š' + (blogDB.length -1) + 'ã€€ã€€ã€€Check â¶ï¼š';
            let button6=document.querySelector('#num_1');
            button6.value=pub_1;
            button6.max=pub_1;
            let span8=document.querySelector('#snap_result2');
            span8.textContent='Check â·ï¼š';
            let button9=document.querySelector('#num_2');
            button9.value=pub_2;
            button9.max=pub_2; }


        function hit_display(){
            let ch1=document.querySelectorAll('.ch1');
            let ch2=document.querySelectorAll('.ch2');
            for(let k=0; k<ch1.length; k++){
                let index=entry_id_DB.indexOf(entry_id[k].value);
                if(index!=-1){ // IDãŒblogDBã«è¨˜éŒ²ã•ã‚Œã¦ã„ãŸå ´åˆ
                    if(blogDB[index][1]==1){
                        ch1[k].style.opacity='1'; }
                    else{
                        ch1[k].style.opacity='0'; }
                    if(blogDB[index][2]==1){
                        ch2[k].style.opacity='1'; }
                    else{
                        ch2[k].style.opacity='0'; }}}}


        function hit_display_clear(){
            let ch1=document.querySelectorAll('.ch1');
            let ch2=document.querySelectorAll('.ch2');
            for(let k=0; k<ch1.length; k++){
                ch1[k].style.opacity='0';
                ch2[k].style.opacity='0'; }}


        function next(x){ // xã¯ãƒšãƒ¼ã‚¸å†…ã®è¨˜äº‹index[0ï½length-1]
            entry_id=document.querySelectorAll('input[name="entry_id"]');
            if(entry_id.length >x){
                open_win(x); } // æŠ•ç¨¿è¨˜äº‹ãŒã‚ã‚‹å ´åˆ open_win ã‚’é–‹å§‹
            else{
                next_call();}} // æŠ•ç¨¿è¨˜äº‹ãŒç„¡ã‘ã‚Œã° æ¬¡ãƒšãƒ¼ã‚¸ã‚’call ã™ã‚‹


        function open_win(k){
            next_target=k; // é€ä¿¡å®Œäº†ã¾ã§ã¯æœªå‡¦ç†ã¨ã™ã‚‹

            new_win=Array(entry_target.length);
            link_target=Array(entry_target.length);
            link_target[k]='/ucs/entry/srventryupdateinput.do?id='+ entry_id[k].value;

            if(drive_mode=='c'){
                let win_option='top=20, left=40, width=800, height=300';
                new_win[k]=window.open(link_target[k], k, win_option);

                list_bar[k].style.boxShadow='inset 0 0 0 2px #03a9f4'; // ãƒªã‚¹ãƒˆæ¬„ã«é’æ è¡¨ç¤º
                new_win[k].addEventListener('load', work, false); } // å­ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã®å‡¦ç† ğŸŸ¦


            function work(){
                let editor_flg=new_win[k].document.querySelector('input[name="editor_flg"]');
                if(editor_flg.value=="5"){ // æœ€æ–°ç‰ˆã‚¨ãƒ‡ã‚£ã‚¿ã®æ–‡æ›¸ã®å ´åˆã®ã¿å‡¦ç†

                    let interval=setInterval(find_iframe, 100); // iframe èª­è¾¼ã¿å¾…æ©Ÿã‚³ãƒ¼ãƒ‰ ğŸŸ¥
                    function find_iframe(){
                        let editor_iframe=new_win[k].document.querySelector('.cke_wysiwyg_frame');
                        if(editor_iframe){
                            let iframe_doc=editor_iframe.contentWindow.document;
                            if(iframe_doc){
                                clearInterval(interval);
                                task();

                                function task(){ // taskã¯è‡ªå‹•ã§é–‹ã„ãŸãƒšãƒ¼ã‚¸ã§ã®ä½œæ¥­ã‚³ãƒ¼ãƒ‰ / ä½œæ¥­ç›®çš„ã§è‡ªè£½ ğŸŸ¥

                                    let promise=new Promise((resolve, reject)=>{
                                        let svg_img=iframe_doc.querySelector('svg');
                                        if(svg_img){ // ç·¨é›†éå¯¾å¿œ â¬›ğŸŸ§â¬›
                                            send_result(1);
                                            reject(); }
                                        else{ // h2ãƒ»h3 ã®æ›¸æ›ãˆ
                                            let h2_s=iframe_doc.querySelectorAll('h2 > span');
                                            for(let k=0; k<h2_s.length; k++){
                                                let s2_style=h2_s[k].getAttribute('style');
                                                if(s2_style){
                                                    rep_hs(h2_s[k], s2_style); }}

                                            let h3_s=iframe_doc.querySelectorAll('h3 > span');
                                            for(let k=0; k<h3_s.length; k++){
                                                let s3_style=h3_s[k].getAttribute('style');
                                                if(s3_style){
                                                    rep_hs(h3_s[k], s3_style); }}

                                            function rep_hs(h_elem, inline_s){
                                                let s_style1=inline_s.replace('0.32em 1em 0.2em', '.26em 1em .24em');
                                                let s_style2=s_style1.replace('.32em 1em .2em', '.26em 1em .24em');
                                                h_elem.setAttribute('style', s_style2); }
                                            resolve();
                                        } // else

                                    })
                                    .then(()=>{
                                        let not=0; // h2ãƒ»h3 ã®æ›¸æ›ãˆãƒã‚§ãƒƒã‚¯
                                        let h2_s_=iframe_doc.querySelectorAll('h2 > span');
                                        for(let k=0; k<h2_s_.length; k++){
                                            let s2_pad=h2_s_[k].style.padding;
                                            if(s2_pad){
                                                if(s2_pad!='0.26em 1em 0.24em' && s2_pad!='.26em 1em .24em'){
                                                    not+=1;
                                                    break; }}}

                                        let h3_s_=iframe_doc.querySelectorAll('h3 > span');
                                        for(let k=0; k<h3_s_.length; k++){
                                            let s3_pad=h3_s_[k].style.padding;
                                            if(s3_pad){
                                                if(s3_pad!='0.26em 1em 0.24em' && s3_pad!='.26em 1em .24em'){
                                                    not+=1;
                                                    break; }}}

                                        if(not==0){ // å‡¦ç†æˆåŠŸ â¬›ğŸŸ§â¬›
                                            send_result(0);
                                            publish_do(k); }
                                        else{ // ç·¨é›†ä¸æˆåŠŸã®å ´åˆ  â¬›ğŸŸ§â¬›
                                            send_result(1); }

                                    })
                                    .catch(()=>{

                                    })
                                    .then((val) => {
                                        strage_write();
                                        snap_disp();
                                        hit_display();
                                        end_target();
                                    });


                                    function send_result(n){
                                        let index=entry_id_DB.indexOf(entry_id[k].value);
                                        if(index==-1){ // IDãŒblogDBã«è¨˜éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆ
                                            if(n==1){
                                                blogDB.push([entry_id[k].value, 1, 0]); }} // è¨˜äº‹ID/ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
                                        else{ // IDãŒblogDBã«è¨˜éŒ²ã•ã‚Œã¦ã„ãŸå ´åˆ
                                            if(n==1){
                                                blogDB[index][1]=1; } // è¨˜äº‹ID/ãƒ•ãƒ©ã‚°ã€Œ1ã€ã‚’æ›´æ–°
                                            else{
                                                blogDB[index][1]=0; }} // è¨˜äº‹ID/ãƒ•ãƒ©ã‚°ã€Œ0ã€ã‚’æ›´æ–°
                                        reg_set(); }

                                } // task_in()


                                function strage_write(){
                                    let write_json=JSON.stringify(blogDB);
                                    localStorage.setItem('EPW_DB_back', write_json); }// ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜


                                function publish_do(k){
                                    let publish_flg=new_win[k].document.querySelector('input[name="publish_flg"]');
                                    let val=publish_flg.getAttribute('value');

                                    let publish_b0=new_win[k].document.querySelector('button.js-submitButton[publishflg="0"]');
                                    let publish_b1=new_win[k].document.querySelector('button.js-submitButton[publishflg="1"]');
                                    if(val=='0'){ publish_b0.click(); }
                                    if(val=='1'){ publish_b1.click(); }
                                    if(val=='2'){ publish_b0.click(); }}

                            }}}

                } // if(editor_flg.value=="5") // æœ€æ–°ç‰ˆã‚¨ãƒ‡ã‚£ã‚¿ã®æ–‡æ›¸ã®å ´åˆã®ã¿å‡¦ç†

                else{ // ã‚¿ã‚°ç·¨é›†ã‚¨ãƒ‡ã‚£ã‚¿ã®å ´åˆ
                    let index=entry_id_DB.indexOf(entry_id[k].value);
                    if(index==-1){ // IDãŒblogDBã«è¨˜éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆ
                        blogDB.push([entry_id[k].value, 1, 0]); } // è¨˜äº‹ID/ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
                    else{ // IDãŒblogDBã«è¨˜éŒ²ã•ã‚Œã¦ã„ãŸå ´åˆ
                        blogDB[index][1]=1; } // è¨˜äº‹ID/ãƒ•ãƒ©ã‚°ã€Œ1ã€ã‚’æ›´æ–°
                    reg_set();

                    end_target(); }

            } // work()


            function end_target(){ // çµ‚äº†å‡¦ç†
                let editor_flg=new_win[k].document.querySelector('input[name="editor_flg"]');
                list_bar[k].style.boxShadow='none';
                if(editor_flg.value=='5'){
                    list_bar[k].style.background='#caedf2'; }
                else{
                    list_bar[k].style.background='#eceff1'; }

                new_win[k].close();
                setTimeout(()=>{
                    next_do(k); }, 10); //â©

                function next_do(k){
                    next_target=k+1;
                    if(next_target<entry_target.length){ open_win(next_target); }
                    else{ next_call(); }}} // ãƒšãƒ¼ã‚¸ã®çµ‚ã‚Šã¾ã§çµ‚äº†ã—ãŸçŠ¶æ…‹

        } // open_win()


        function next_call(){
            let win_url;
            let current;
            let pageid;
            let next_url;
            let pager;
            let end;

            blogDB[0][1]='c'; // é€£ç¶šå‹•ä½œãƒ•ãƒ©ã‚°ã‚’é€£ç¶šã«ã‚»ãƒƒãƒˆ
            let write_json=JSON.stringify(blogDB);
            localStorage.setItem('EPW_DB_back', write_json); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜

            win_url=window.location.search.substring(1,window.location.search.length);
            current=win_url.slice(-6);

            if(win_url.indexOf('pageID') ==-1){ // pageIDãŒç„¡ã„ æœˆã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®å ´åˆ
                pager=document.querySelector('.pagingArea');
                if(pager){ // ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ãŒæœ‰ã‚Šãã®æœ«å°¾ã§ãªã‘ã‚Œã°åŒæœˆæ¬¡ãƒšãƒ¼ã‚¸ã¸
                    next_url=
                        'https://blog.ameba.jp/ucs/entry/srventrylist.do?pageID=2&entry_ym=' + current;
                    window.open( next_url, '_self'); }
                else{ // ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ãŒç„¡ã‘ã‚Œã°æ¬¡æœˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸
                    current=make_next(current);
                    if(current!=0){ // ç¾åœ¨ã‚’è¶Šãˆãªã„ãªã‚‰æ¬¡æœˆã¸
                        next_url=
                            'https://blog.ameba.jp/ucs/entry/srventrylist.do?entry_ym=' + current;
                        window.open( next_url, '_self'); }
                    else{ // ç¾åœ¨ã‚’è¶ŠãˆãŸã‚‰0ãŒæˆ»ã‚Šåœæ­¢
                        when_edge(); }}}

            else{ // pageIDã‚’å«ã¿ æœˆã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§ãªã„å ´åˆ
                end=document.querySelector('.pagingArea .disabled.next');
                if(!end){ // ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ã®æœ«å°¾ã§ãªã‘ã‚Œã°åŒæœˆæ¬¡ãƒšãƒ¼ã‚¸ã¸
                    pageid=parseInt(win_url.slice(7).slice(0, -16), 10) +1;
                    next_url=
                        'https://blog.ameba.jp/ucs/entry/srventrylist.do?pageID='+ pageid + '&entry_ym=' + current;
                    window.open( next_url, '_self'); }
                else{ // ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ã®æœ«å°¾ãªã‚‰æ¬¡æœˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸
                    current=make_next(current);
                    if(current!=0){ // ç¾åœ¨ã‚’è¶Šãˆãªã„ãªã‚‰æ¬¡æœˆã¸
                        next_url=
                            'https://blog.ameba.jp/ucs/entry/srventrylist.do?entry_ym=' + current;
                        window.open( next_url, '_self'); }
                    else{ // ç¾åœ¨ã‚’è¶ŠãˆãŸã‚‰0ãŒæˆ»ã‚Šåœæ­¢
                        when_edge(); }}}

            function make_next(curr){
                let ym;
                let y;
                let m;
                ym=parseInt(curr, 10); // 10é€²æ•°å€¤åŒ–
                y=Math.floor(ym/100); // å¹´ã¯100ã§å‰²ã£ãŸå•†
                m=ym % 100; // æœˆã¯100ã§å‰²ã£ãŸä½™ã‚Š
                if(m !=12){
                    ym=100*y + m +1; }
                else{
                    ym=100*y + 101; }

                let now=new Date();
                if(ym > 100*now.getFullYear() + now.getMonth() +1){
                    return 0; } // ç¾åœ¨ã®æœˆã‚’è¶Šãˆã‚‹å ´åˆã¯0ã‚’è¿”ã™
                else{
                    return ym; }} // æ¬¡å¹´æœˆã®æ•°å€¤ã‚’è¿”ã™

            function when_edge(){
                blogDB[0][1]='s'; // é€£ç¶šå‹•ä½œãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                let write_json=JSON.stringify(blogDB);
                localStorage.setItem('EPW_DB_back', write_json); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜
                document.querySelector('#div0').remove();
                document.querySelector('#div1').remove();
                control_pannel('e'); } // å…¨ä½œæ¥­ã®çµ‚äº†æ™‚ã®è¡¨ç¤ºã‚’ã•ã›ã‚‹
        } // next_call()


        // ç·¨é›†æ¸ˆã¿ã®è¨˜äº‹ã«ãƒãƒ¼ã‚¯ã‚’ä»˜ã‘ã‚‹
        let ed_sw=document.querySelectorAll('.actions .action:first-child');
        for(let k=0; k<ed_sw.length; k++){
            ed_sw[k].onmousedown=()=>{
                ed_sw[k].style.boxShadow='inset #2196f3 -16px 0 0 -10px'; }}

        let ed_link=document.querySelectorAll('.actions a');
        for(let k=0; k<ed_link.length; k++){
            ed_link[k].setAttribute('target', '_blank'); }

    } // è¦ªã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã®æ¡ä»¶




    if(body_id=='entryCreate'){ // æŠ•ç¨¿å¾Œã®çµ‚äº†ç”»é¢
        let err=document.querySelector('.p-error');
        if(!err){
            window.close();
        }}
});



